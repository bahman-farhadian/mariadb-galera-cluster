# HAProxy Configuration for MariaDB Galera Cluster
# Generated by Ansible

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  30m
    timeout server  30m

listen mariadb_cluster
    bind 0.0.0.0:{{ mysql_port }}
    mode tcp
    option tcplog
    option tcpka
    balance roundrobin
    option tcp-check
    tcp-check connect
{% for node in mariadb_nodes %}
    server {{ node.name }} {{ node.ip }}:{{ mysql_port }} check inter 5s rise 2 fall 3
{% endfor %}

{% if haproxy_stats_enabled | default(true) %}
listen stats
    bind 0.0.0.0:{{ haproxy_stats_port | default(8404) }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 1s
    stats show-legends
    stats show-node
    stats admin if TRUE
    stats auth {{ haproxy_stats_user | default('admin') }}:{{ haproxy_stats_password | default('admin') }}
{% endif %}
