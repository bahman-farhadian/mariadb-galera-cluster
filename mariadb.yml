---
# =============================================================================
# MariaDB Galera Cluster - Unified Playbook (Idempotent + Parallel)
# =============================================================================
#
# DEPLOY:
#   ansible-playbook mariadb.yml --tags deploy
#   ansible-playbook mariadb.yml --tags deploy-mariadb
#   ansible-playbook mariadb.yml --tags deploy-haproxy
#   ansible-playbook mariadb.yml --tags deploy-garbd
#
# STATUS:
#   ansible-playbook mariadb.yml --tags status
#   ansible-playbook mariadb.yml --tags status-detailed
#
# RECOVER (requires --extra-vars):
#   ansible-playbook mariadb.yml --tags recover -e confirm=yes
#
# FORCE FRESH INSTALL (destroys existing cluster):
#   ansible-playbook mariadb.yml --tags deploy -e force_bootstrap=yes
#
# =============================================================================

# =============================================================================
# COMMON: Build Dynamic Inventory
# =============================================================================
- name: Build Dynamic Inventory
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Validate minimum node count
      ansible.builtin.fail:
        msg: "Minimum 2 MariaDB nodes required. You have {{ mariadb_nodes | length }}."
      when: mariadb_nodes | length < 2

    - name: Validate garbd configuration
      ansible.builtin.fail:
        msg: "garbd_enabled is true but garbd_nodes is empty."
      when: garbd_enabled and (garbd_nodes | length == 0)

    - name: Add MariaDB nodes to inventory
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: mariadb
        server_id: "{{ idx + 1 }}"
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ mariadb_nodes }}"
      loop_control:
        index_var: idx

    - name: Add HAProxy nodes to inventory
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: loadbalancers
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ haproxy_nodes }}"
      when: haproxy_nodes | length > 0

    - name: Add Garbd nodes to inventory
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: garbd
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ garbd_nodes }}"
      when: garbd_enabled and garbd_nodes | length > 0

# =============================================================================
# COMMON: Prepare Remote Hosts
# =============================================================================
- name: Prepare Remote Hosts
  hosts: mariadb:loadbalancers:garbd
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb, deploy-haproxy, deploy-garbd, status, status-detailed, recover]
  tasks:
    - name: Ensure Ansible temp directory exists
      ansible.builtin.raw: mkdir -p ~/.ansible/tmp && chmod 0700 ~/.ansible/tmp
      changed_when: false

# =============================================================================
# DEPLOY: Detect Cluster State
# =============================================================================
- name: Detect Cluster State
  hosts: mariadb
  become: true
  gather_facts: true
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Check if MariaDB is installed
      ansible.builtin.stat:
        path: /usr/sbin/mariadbd
      register: mariadb_binary

    - name: Check if MariaDB service is active
      ansible.builtin.command: systemctl is-active mariadb
      register: mariadb_active
      changed_when: false
      failed_when: false

    - name: Check wsrep cluster status
      ansible.builtin.shell: |
        # Try socket auth first, then with password
        mariadb --socket=/run/mysqld/mysqld.sock -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || echo "0"
      register: wsrep_size
      changed_when: false
      failed_when: false
      no_log: true
      when: mariadb_active.rc == 0

    - name: Set node state
      ansible.builtin.set_fact:
        node_installed: "{{ mariadb_binary.stat.exists }}"
        node_running: "{{ mariadb_active.rc == 0 }}"
        node_in_cluster: "{{ (wsrep_size.stdout | default('0') | int) > 0 }}"
        node_cluster_size: "{{ wsrep_size.stdout | default('0') | int }}"

- name: Evaluate Cluster State
  hosts: localhost
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Determine if cluster exists
      ansible.builtin.set_fact:
        cluster_is_healthy: >-
          {{ groups['mariadb'] | map('extract', hostvars, 'node_in_cluster') | select('equalto', true) | list | length > 0 }}
        any_node_running: >-
          {{ groups['mariadb'] | map('extract', hostvars, 'node_running') | select('equalto', true) | list | length > 0 }}
        all_nodes_installed: >-
          {{ groups['mariadb'] | map('extract', hostvars, 'node_installed') | reject('equalto', true) | list | length == 0 }}
        force_bootstrap: "{{ force_bootstrap | default(false) | bool }}"

    - name: Display cluster state
      ansible.builtin.debug:
        msg: |
          ============================================
          MariaDB Galera Cluster - Deploy
          ============================================
          Cluster Name: {{ cluster_name }}
          MariaDB Nodes: {{ mariadb_nodes | length }}
          HAProxy Nodes: {{ haproxy_nodes | length }}
          Garbd: {{ 'enabled' if garbd_enabled else 'disabled' }}
          --------------------------------------------
          Cluster Healthy: {{ cluster_is_healthy }}
          Any Node Running: {{ any_node_running }}
          All Installed: {{ all_nodes_installed }}
          Force Bootstrap: {{ force_bootstrap }}
          --------------------------------------------
          Mode: {{ 'FORCE BOOTSTRAP' if force_bootstrap else ('Update/Verify' if cluster_is_healthy else 'Fresh Install') }}
          ============================================

# =============================================================================
# DEPLOY: Install Packages (PARALLEL - Skip if installed)
# =============================================================================
- name: Install MariaDB Packages
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Install packages block
      when: not node_installed
      block:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 3600

        - name: Install MariaDB and Galera packages
          ansible.builtin.apt:
            name:
              - mariadb-server
              - galera-4
              - python3-pymysql
              - rsync
            state: present

        - name: Install mariabackup
          ansible.builtin.apt:
            name: mariadb-backup
            state: present
          when: sst_method == "mariabackup"

    - name: Ensure directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: mysql
        group: mysql
        mode: "0750"
      loop:
        - "{{ mysql_log_dir }}"
        - "{{ mysql_data_dir }}"

# =============================================================================
# DEPLOY: Configure Galera (PARALLEL)
# =============================================================================
- name: Configure MariaDB Galera
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Configure bind address
      ansible.builtin.lineinfile:
        path: "{{ mysql_conf_dir }}/50-server.cnf"
        regexp: "^bind-address"
        line: "bind-address = 0.0.0.0"
        backup: true
      register: bind_changed

    - name: Deploy Galera configuration
      ansible.builtin.template:
        src: templates/60-galera.cnf.j2
        dest: "{{ mysql_conf_dir }}/60-galera.cnf"
        owner: root
        group: root
        mode: "0644"
        backup: true
      register: galera_changed

    - name: Set config changed fact
      ansible.builtin.set_fact:
        config_changed: "{{ bind_changed.changed or galera_changed.changed }}"

# =============================================================================
# DEPLOY: Fresh Install Bootstrap (Only if no cluster exists)
# =============================================================================
- name: Fresh Install - Prepare All Nodes
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Fresh install preparation
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Stop MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: stopped
          ignore_errors: true

        - name: Create grastate.dat
          ansible.builtin.copy:
            content: |
              # GALERA saved state
              version: 2.1
              uuid: 00000000-0000-0000-0000-000000000000
              seqno: -1
              safe_to_bootstrap: 0
            dest: "{{ mysql_data_dir }}/grastate.dat"
            owner: mysql
            group: mysql
            mode: "0644"
            force: true

- name: Fresh Install - Bootstrap First Node
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Bootstrap new cluster
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Set safe_to_bootstrap
          ansible.builtin.lineinfile:
            path: "{{ mysql_data_dir }}/grastate.dat"
            regexp: "^safe_to_bootstrap:"
            line: "safe_to_bootstrap: 1"

        - name: Bootstrap cluster
          ansible.builtin.command: galera_new_cluster

        - name: Wait for bootstrap
          ansible.builtin.wait_for:
            port: "{{ mysql_port }}"
            host: "{{ node_ip }}"
            delay: 3
            timeout: 60

- name: Fresh Install - Start Remaining Nodes
  hosts: mariadb[1:]
  become: true
  gather_facts: false
  serial: 1
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Start remaining nodes
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Start MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: started
            enabled: true

        - name: Wait for sync
          ansible.builtin.shell: |
            # Wait for port to be open and service stable
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                # Port open and service active, wait a bit for sync to complete
                sleep 5
                exit 0
              fi
              sleep 3
            done
            exit 1
          changed_when: false

# =============================================================================
# DEPLOY: Existing Cluster - Rolling Restart (Only if config changed)
# =============================================================================
- name: Existing Cluster - Rolling Restart
  hosts: mariadb
  become: true
  gather_facts: false
  serial: 1
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Rolling restart if config changed
      when:
        - hostvars['localhost']['cluster_is_healthy']
        - not hostvars['localhost']['force_bootstrap']
        - config_changed
      block:
        - name: Restart MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: restarted

        - name: Wait for sync
          ansible.builtin.shell: |
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                sleep 5
                exit 0
              fi
              sleep 3
            done
            exit 1
          changed_when: false

# =============================================================================
# DEPLOY: Ensure All Nodes Running
# =============================================================================
- name: Ensure All Nodes Running
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Ensure MariaDB running
      ansible.builtin.systemd:
        name: mariadb
        state: started
        enabled: true

# =============================================================================
# DEPLOY: Secure Cluster
# =============================================================================
- name: Secure Cluster
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Wait for MariaDB socket
      ansible.builtin.wait_for:
        path: /run/mysqld/mysqld.sock
        timeout: 30

    - name: Check if root password is already set
      ansible.builtin.shell: |
        mariadb --socket=/run/mysqld/mysqld.sock -e "SELECT 1;" 2>/dev/null && echo "no_password" || echo "has_password"
      register: root_password_check
      changed_when: false
      failed_when: false

    - name: Set root password (first time only)
      community.mysql.mysql_user:
        name: root
        password: "{{ mariadb_root_password }}"
        host_all: true
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      no_log: true
      when: root_password_check.stdout == "no_password"

    - name: Create admin user
      community.mysql.mysql_user:
        name: "{{ admin_user }}"
        password: "{{ admin_password }}"
        host: "%"
        priv: "*.*:ALL,GRANT"
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      no_log: true

    - name: Create SST user
      community.mysql.mysql_user:
        name: "{{ sst_user }}"
        password: "{{ sst_password }}"
        host: "localhost"
        priv: "*.*:RELOAD,PROCESS,LOCK TABLES,REPLICATION CLIENT"
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      when: sst_method == "mariabackup"
      no_log: true

    - name: Remove anonymous users
      community.mysql.mysql_user:
        name: ""
        host_all: true
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: absent
      no_log: true
      ignore_errors: true

    - name: Remove test database
      community.mysql.mysql_db:
        name: test
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: absent
      no_log: true
      ignore_errors: true

# =============================================================================
# DEPLOY: Galera Arbitrator
# =============================================================================
- name: Deploy Galera Arbitrator
  hosts: garbd
  become: true
  gather_facts: true
  tags: [deploy, deploy-garbd]
  tasks:
    - name: Install Galera Arbitrator
      ansible.builtin.apt:
        name: galera-arbitrator-4
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Configure Galera Arbitrator
      ansible.builtin.template:
        src: templates/garb.j2
        dest: /etc/default/garb
        mode: "0644"
      register: garbd_config

    - name: Restart garbd if config changed
      ansible.builtin.systemd:
        name: garb
        state: restarted
        enabled: true
      when: garbd_config.changed

    - name: Ensure garbd running
      ansible.builtin.systemd:
        name: garb
        state: started
        enabled: true

# =============================================================================
# DEPLOY: HAProxy Load Balancers
# =============================================================================
- name: Deploy HAProxy Load Balancers
  hosts: loadbalancers
  become: true
  gather_facts: true
  tags: [deploy, deploy-haproxy]
  tasks:
    - name: Install HAProxy
      ansible.builtin.apt:
        name: haproxy
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Deploy HAProxy configuration
      ansible.builtin.template:
        src: templates/haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        owner: root
        group: root
        mode: "0644"
        backup: true
        validate: "haproxy -c -f %s"
      register: haproxy_config

    - name: Restart HAProxy if config changed
      ansible.builtin.systemd:
        name: haproxy
        state: restarted
        enabled: true
        daemon_reload: true
      when: haproxy_config.changed

    - name: Ensure HAProxy running
      ansible.builtin.systemd:
        name: haproxy
        state: started
        enabled: true

    - name: Verify HAProxy listening
      ansible.builtin.shell: ss -tlnp | grep ":{{ mysql_port }}"
      register: haproxy_check
      changed_when: false
      retries: 3
      delay: 2
      until: haproxy_check.rc == 0

# =============================================================================
# DEPLOY: Verification
# =============================================================================
- name: Verify Deployment
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Get cluster size
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null || echo "0"
      register: final_size
      changed_when: false
      no_log: true

    - name: Display result
      ansible.builtin.debug:
        msg: |
          ============================================
          Deployment Complete!
          ============================================
          Cluster Size: {{ final_size.stdout }}/{{ mariadb_nodes | length }}
          {% if haproxy_nodes | length > 0 %}
          Connect: mysql -h {{ haproxy_nodes[0].ip }} -u {{ admin_user }} -p
          Stats: http://{{ haproxy_nodes[0].ip }}:{{ haproxy_stats_port }}/stats
          {% else %}
          Connect: mysql -h {{ mariadb_nodes[0].ip }} -u {{ admin_user }} -p
          {% endif %}
          ============================================

# =============================================================================
# STATUS: Check Cluster Status
# =============================================================================
- name: Check MariaDB Status
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service status
      ansible.builtin.command: systemctl is-active mariadb
      register: svc_status
      changed_when: false
      failed_when: false

    - name: Get wsrep status
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "
        SELECT CONCAT_WS(',',
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_status'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_local_state_comment'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_ready')
        );" 2>/dev/null || echo "N/A,N/A,N/A,N/A"
      register: wsrep_info
      changed_when: false
      failed_when: false
      no_log: true

    - name: Set status fact
      ansible.builtin.set_fact:
        node_status:
          name: "{{ node_name }}"
          ip: "{{ node_ip }}"
          service: "{{ svc_status.stdout | default('unknown') }}"
          cluster_size: "{{ wsrep_info.stdout.split(',')[0] | default('N/A') }}"
          cluster_status: "{{ wsrep_info.stdout.split(',')[1] | default('N/A') }}"
          state: "{{ wsrep_info.stdout.split(',')[2] | default('N/A') }}"
          ready: "{{ wsrep_info.stdout.split(',')[3] | default('N/A') }}"

- name: Check HAProxy Status
  hosts: loadbalancers
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service
      ansible.builtin.command: systemctl is-active haproxy
      register: ha_status
      changed_when: false
      failed_when: false

    - name: Check port
      ansible.builtin.shell: ss -tlnp | grep -q ":{{ mysql_port }}" && echo "listening" || echo "not listening"
      register: ha_port
      changed_when: false

    - name: Set status
      ansible.builtin.set_fact:
        haproxy_status:
          name: "{{ node_name }}"
          ip: "{{ node_ip }}"
          service: "{{ ha_status.stdout }}"
          port: "{{ ha_port.stdout }}"

- name: Check Garbd Status
  hosts: garbd
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service
      ansible.builtin.command: systemctl is-active garb
      register: garb_status
      changed_when: false
      failed_when: false

    - name: Set status
      ansible.builtin.set_fact:
        garbd_status:
          name: "{{ node_name }}"
          ip: "{{ node_ip }}"
          service: "{{ garb_status.stdout }}"

- name: Display Status
  hosts: localhost
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Show cluster status
      ansible.builtin.debug:
        msg: |
          ============================================
          MariaDB Galera Cluster Status
          ============================================
          
          MARIADB NODES:
          {% for h in groups['mariadb'] %}
          {{ hostvars[h]['node_status']['name'] }} ({{ hostvars[h]['node_status']['ip'] }})
            Service: {{ hostvars[h]['node_status']['service'] }}
            Cluster: {{ hostvars[h]['node_status']['cluster_size'] }} nodes | {{ hostvars[h]['node_status']['cluster_status'] }}
            State: {{ hostvars[h]['node_status']['state'] }} | Ready: {{ hostvars[h]['node_status']['ready'] }}
          {% endfor %}
          {% if groups['loadbalancers'] | default([]) | length > 0 %}
          
          HAPROXY:
          {% for h in groups['loadbalancers'] %}
          {{ hostvars[h]['haproxy_status']['name'] }} ({{ hostvars[h]['haproxy_status']['ip'] }})
            Service: {{ hostvars[h]['haproxy_status']['service'] }} | Port: {{ hostvars[h]['haproxy_status']['port'] }}
          {% endfor %}
          {% endif %}
          {% if groups['garbd'] | default([]) | length > 0 %}
          
          GARBD:
          {% for h in groups['garbd'] %}
          {{ hostvars[h]['garbd_status']['name'] }}: {{ hostvars[h]['garbd_status']['service'] }}
          {% endfor %}
          {% endif %}
          ============================================

- name: Detailed Status
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [status-detailed]
  tasks:
    - name: Get full wsrep status
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -e "SHOW STATUS LIKE 'wsrep_%';" 2>/dev/null
      register: full_wsrep
      changed_when: false
      failed_when: false
      no_log: true

    - name: Display
      ansible.builtin.debug:
        msg: |
          === {{ node_name }} ===
          {{ full_wsrep.stdout }}
      when: full_wsrep.rc == 0

# =============================================================================
# RECOVER: Cluster Recovery (Requires -e confirm=yes)
# =============================================================================
- name: Validate Recovery Request
  hosts: localhost
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Check confirmation
      ansible.builtin.fail:
        msg: |
          ============================================
          RECOVERY REQUIRES CONFIRMATION
          ============================================
          This will:
          1. Stop all MariaDB and garbd services
          2. Find the most up-to-date node
          3. Bootstrap cluster from that node
          4. Rejoin all other nodes
          
          Run with: ansible-playbook mariadb.yml --tags recover -e confirm=yes
          ============================================
      when: not (confirm | default(false) | bool)

    - name: Recovery confirmed
      ansible.builtin.debug:
        msg: "Recovery confirmed. Proceeding..."
      when: confirm | default(false) | bool

- name: Stop All MariaDB
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Stop MariaDB
      ansible.builtin.systemd:
        name: mariadb
        state: stopped
      ignore_errors: true
      when: confirm | default(false) | bool

- name: Stop All Garbd
  hosts: garbd
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Stop garbd
      ansible.builtin.systemd:
        name: garb
        state: stopped
      ignore_errors: true
      when: confirm | default(false) | bool

- name: Find Best Node
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Read grastate
      ansible.builtin.slurp:
        src: "{{ mysql_data_dir }}/grastate.dat"
      register: grastate
      ignore_errors: true
      when: confirm | default(false) | bool

    - name: Parse seqno
      ansible.builtin.set_fact:
        node_seqno: "{{ (grastate.content | b64decode | regex_search('seqno:\\s*(-?\\d+)', '\\1'))[0] | default('-1') }}"
      when:
        - confirm | default(false) | bool
        - grastate is succeeded

    - name: Default seqno
      ansible.builtin.set_fact:
        node_seqno: "-1"
      when:
        - confirm | default(false) | bool
        - grastate is failed

    - name: Show seqno
      ansible.builtin.debug:
        msg: "{{ node_name }}: seqno={{ node_seqno }}"
      when: confirm | default(false) | bool

- name: Select Bootstrap Node
  hosts: localhost
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Find best node
      when: confirm | default(false) | bool
      block:
        - name: Collect seqnos
          ansible.builtin.set_fact:
            seqnos: "{{ seqnos | default({}) | combine({item: hostvars[item]['node_seqno'] | int}) }}"
          loop: "{{ groups['mariadb'] }}"

        - name: Select highest
          ansible.builtin.set_fact:
            bootstrap_node: "{{ (seqnos | dict2items | sort(attribute='value', reverse=true) | first).key }}"

        - name: Display selection
          ansible.builtin.debug:
            msg: "Bootstrap node: {{ bootstrap_node }}"

- name: Bootstrap Recovery
  hosts: mariadb
  become: true
  gather_facts: false
  serial: 1
  tags: [recover]
  tasks:
    - name: Recovery bootstrap
      when: confirm | default(false) | bool
      block:
        - name: Check if bootstrap node
          ansible.builtin.set_fact:
            is_bootstrap: "{{ inventory_hostname == hostvars['localhost']['bootstrap_node'] }}"

        - name: Set safe_to_bootstrap
          ansible.builtin.lineinfile:
            path: "{{ mysql_data_dir }}/grastate.dat"
            regexp: "^safe_to_bootstrap:"
            line: "safe_to_bootstrap: 1"
          when: is_bootstrap

        - name: Bootstrap
          ansible.builtin.command: galera_new_cluster
          when: is_bootstrap

        - name: Wait for bootstrap
          ansible.builtin.wait_for:
            port: "{{ mysql_port }}"
            host: "{{ node_ip }}"
            delay: 3
            timeout: 120
          when: is_bootstrap

        - name: Start other nodes
          ansible.builtin.systemd:
            name: mariadb
            state: started
          when: not is_bootstrap

        - name: Wait for sync
          ansible.builtin.shell: |
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                sleep 5
                exit 0
              fi
              sleep 3
            done
            exit 1
          changed_when: false
          when: not is_bootstrap

- name: Restart Garbd
  hosts: garbd
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Start garbd
      ansible.builtin.systemd:
        name: garb
        state: started
      when: confirm | default(false) | bool

- name: Verify Recovery
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Get cluster size
      ansible.builtin.shell: |
        mariadb --socket=/run/mysqld/mysqld.sock -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || echo "0"
      register: size
      changed_when: false
      no_log: true
      when: confirm | default(false) | bool

    - name: Display result
      ansible.builtin.debug:
        msg: |
          ============================================
          Recovery Complete!
          ============================================
          Cluster Size: {{ size.stdout }}/{{ mariadb_nodes | length }}
          ============================================
      when: confirm | default(false) | bool
