---
# =============================================================================
# MariaDB Galera Cluster - Unified Playbook
# =============================================================================
#
# DEPLOY:
#   ansible-playbook mariadb.yml --tags deploy
#   ansible-playbook mariadb.yml --tags deploy-mariadb
#   ansible-playbook mariadb.yml --tags deploy-haproxy
#   ansible-playbook mariadb.yml --tags deploy-garbd
#
# STATUS:
#   ansible-playbook mariadb.yml --tags status
#   ansible-playbook mariadb.yml --tags status-detailed
#
# RECOVER:
#   ansible-playbook mariadb.yml --tags recover -e confirm=yes
#
# FORCE BOOTSTRAP (destroys existing cluster):
#   ansible-playbook mariadb.yml --tags deploy -e force_bootstrap=yes
#
# =============================================================================

# =============================================================================
# COMMON: Build Dynamic Inventory
# =============================================================================
- name: Build Dynamic Inventory
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Validate minimum node count
      ansible.builtin.fail:
        msg: "Minimum 2 MariaDB nodes required."
      when: mariadb_nodes | length < 2

    - name: Validate garbd configuration
      ansible.builtin.fail:
        msg: "garbd_enabled is true but garbd_nodes is empty."
      when: garbd_enabled and (garbd_nodes | length == 0)

    - name: Add MariaDB nodes
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: mariadb
        server_id: "{{ idx + 1 }}"
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ mariadb_nodes }}"
      loop_control:
        index_var: idx

    - name: Add HAProxy nodes
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: loadbalancers
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ haproxy_nodes }}"
      when: haproxy_nodes | length > 0

    - name: Add Garbd nodes
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
        groups: garbd
        node_ip: "{{ item.ip }}"
        node_name: "{{ item.name }}"
      loop: "{{ garbd_nodes }}"
      when: garbd_enabled and garbd_nodes | length > 0

# =============================================================================
# COMMON: Prepare Remote Hosts
# =============================================================================
- name: Prepare Remote Hosts
  hosts: mariadb:loadbalancers:garbd
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb, deploy-haproxy, deploy-garbd, status, status-detailed, recover]
  tasks:
    - name: Create Ansible temp directory
      ansible.builtin.raw: mkdir -p ~/.ansible/tmp && chmod 0700 ~/.ansible/tmp
      changed_when: false

# =============================================================================
# DEPLOY: Detect Cluster State
# =============================================================================
- name: Detect Cluster State
  hosts: mariadb
  become: true
  gather_facts: true
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Check if MariaDB is installed
      ansible.builtin.stat:
        path: /usr/sbin/mariadbd
      register: mariadb_binary

    - name: Check if MariaDB is running
      ansible.builtin.command: systemctl is-active mariadb
      register: mariadb_active
      changed_when: false
      failed_when: false

    - name: Check wsrep cluster size
      ansible.builtin.shell: |
        mariadb --socket=/run/mysqld/mysqld.sock -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || echo "0"
      register: wsrep_size
      changed_when: false
      failed_when: false
      no_log: true
      when: mariadb_active.rc == 0

    - name: Set node state
      ansible.builtin.set_fact:
        node_installed: "{{ mariadb_binary.stat.exists }}"
        node_running: "{{ mariadb_active.rc == 0 }}"
        node_in_cluster: "{{ (wsrep_size.stdout | default('0') | int) > 0 }}"

- name: Evaluate Cluster State
  hosts: localhost
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Determine cluster health
      ansible.builtin.set_fact:
        cluster_is_healthy: "{{ groups['mariadb'] | map('extract', hostvars, 'node_in_cluster') | select('equalto', true) | list | length > 0 }}"
        force_bootstrap: "{{ force_bootstrap | default(false) | bool }}"

    - name: Display cluster state
      ansible.builtin.debug:
        msg: |
          ============================================
          MariaDB Galera Cluster - Deploy
          ============================================
          Cluster: {{ cluster_name }}
          Nodes: {{ mariadb_nodes | length }} MariaDB, {{ haproxy_nodes | length }} HAProxy
          Cluster Healthy: {{ cluster_is_healthy }}
          Force Bootstrap: {{ force_bootstrap }}
          Mode: {{ 'FORCE BOOTSTRAP' if force_bootstrap else ('Update' if cluster_is_healthy else 'Fresh Install') }}
          ============================================

# =============================================================================
# DEPLOY: Install MariaDB (PARALLEL)
# =============================================================================
- name: Install MariaDB
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Install packages
      when: not node_installed
      block:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
            cache_valid_time: 3600

        - name: Install MariaDB packages
          ansible.builtin.apt:
            name:
              - mariadb-server
              - galera-4
              - python3-pymysql
              - rsync
            state: present

        - name: Install mariabackup
          ansible.builtin.apt:
            name: mariadb-backup
            state: present
          when: sst_method == "mariabackup"

    - name: Ensure directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: mysql
        group: mysql
        mode: "0750"
      loop:
        - "{{ mysql_log_dir }}"
        - "{{ mysql_data_dir }}"

# =============================================================================
# DEPLOY: Configure Galera (PARALLEL)
# =============================================================================
- name: Configure MariaDB
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Configure bind address
      ansible.builtin.lineinfile:
        path: "{{ mysql_conf_dir }}/50-server.cnf"
        regexp: "^bind-address"
        line: "bind-address = 0.0.0.0"
        backup: true
      register: bind_changed

    - name: Deploy Galera config
      ansible.builtin.template:
        src: templates/60-galera.cnf.j2
        dest: "{{ mysql_conf_dir }}/60-galera.cnf"
        owner: root
        group: root
        mode: "0644"
        backup: true
      register: galera_changed

    - name: Set config changed
      ansible.builtin.set_fact:
        config_changed: "{{ bind_changed.changed or galera_changed.changed }}"

# =============================================================================
# DEPLOY: Fresh Install - Bootstrap
# =============================================================================
- name: Fresh Install - Prepare Nodes
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Prepare for fresh install
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Stop MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: stopped
          ignore_errors: true

        - name: Create grastate.dat
          ansible.builtin.copy:
            content: |
              # GALERA saved state
              version: 2.1
              uuid: 00000000-0000-0000-0000-000000000000
              seqno: -1
              safe_to_bootstrap: 0
            dest: "{{ mysql_data_dir }}/grastate.dat"
            owner: mysql
            group: mysql
            mode: "0644"
            force: true

- name: Fresh Install - Bootstrap First Node
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Bootstrap cluster
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Set safe_to_bootstrap
          ansible.builtin.lineinfile:
            path: "{{ mysql_data_dir }}/grastate.dat"
            regexp: "^safe_to_bootstrap:"
            line: "safe_to_bootstrap: 1"

        - name: Run galera_new_cluster
          ansible.builtin.command: galera_new_cluster

        - name: Wait for bootstrap
          ansible.builtin.wait_for:
            port: "{{ mysql_port }}"
            host: "{{ node_ip }}"
            delay: 3
            timeout: 60

- name: Fresh Install - Start Remaining Nodes
  hosts: mariadb[1:]
  become: true
  gather_facts: false
  serial: 1
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Start node
      when: not hostvars['localhost']['cluster_is_healthy'] or hostvars['localhost']['force_bootstrap']
      block:
        - name: Start MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: started
            enabled: true

        - name: Wait for sync
          ansible.builtin.shell: |
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                sleep 3
                exit 0
              fi
              sleep 2
            done
            exit 1
          changed_when: false

# =============================================================================
# DEPLOY: Existing Cluster - Rolling Restart
# =============================================================================
- name: Rolling Restart (if config changed)
  hosts: mariadb
  become: true
  gather_facts: false
  serial: 1
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Rolling restart
      when:
        - hostvars['localhost']['cluster_is_healthy']
        - not hostvars['localhost']['force_bootstrap']
        - config_changed
      block:
        - name: Restart MariaDB
          ansible.builtin.systemd:
            name: mariadb
            state: restarted

        - name: Wait for sync
          ansible.builtin.shell: |
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                sleep 3
                exit 0
              fi
              sleep 2
            done
            exit 1
          changed_when: false

# =============================================================================
# DEPLOY: Ensure Running
# =============================================================================
- name: Ensure All Nodes Running
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Ensure MariaDB running
      ansible.builtin.systemd:
        name: mariadb
        state: started
        enabled: true

# =============================================================================
# DEPLOY: Secure Cluster
# =============================================================================
- name: Secure Cluster
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Wait for socket
      ansible.builtin.wait_for:
        path: /run/mysqld/mysqld.sock
        timeout: 30

    - name: Check if password set
      ansible.builtin.shell: |
        mariadb --socket=/run/mysqld/mysqld.sock -e "SELECT 1;" 2>/dev/null && echo "no_password" || echo "has_password"
      register: password_check
      changed_when: false

    - name: Set root password
      community.mysql.mysql_user:
        name: root
        password: "{{ mariadb_root_password }}"
        host_all: true
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      no_log: true
      when: password_check.stdout == "no_password"

    - name: Create admin user
      community.mysql.mysql_user:
        name: "{{ admin_user }}"
        password: "{{ admin_password }}"
        host: "%"
        priv: "*.*:ALL,GRANT"
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      no_log: true

    - name: Create SST user
      community.mysql.mysql_user:
        name: "{{ sst_user }}"
        password: "{{ sst_password }}"
        host: "localhost"
        priv: "*.*:RELOAD,PROCESS,LOCK TABLES,REPLICATION CLIENT"
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: present
      when: sst_method == "mariabackup"
      no_log: true

    - name: Remove anonymous users
      community.mysql.mysql_user:
        name: ""
        host_all: true
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: absent
      no_log: true
      ignore_errors: true

    - name: Remove test database
      community.mysql.mysql_db:
        name: test
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_unix_socket: /run/mysqld/mysqld.sock
        state: absent
      no_log: true
      ignore_errors: true

# =============================================================================
# DEPLOY: Galera Arbitrator
# =============================================================================
- name: Deploy Garbd
  hosts: garbd
  become: true
  gather_facts: true
  tags: [deploy, deploy-garbd]
  tasks:
    - name: Install garbd
      ansible.builtin.apt:
        name: galera-arbitrator-4
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Configure garbd
      ansible.builtin.template:
        src: templates/garb.j2
        dest: /etc/default/garb
        mode: "0644"
      register: garbd_config

    - name: Restart garbd
      ansible.builtin.systemd:
        name: garb
        state: restarted
        enabled: true
      when: garbd_config.changed

    - name: Ensure garbd running
      ansible.builtin.systemd:
        name: garb
        state: started
        enabled: true

# =============================================================================
# DEPLOY: HAProxy
# =============================================================================
- name: Deploy HAProxy
  hosts: loadbalancers
  become: true
  gather_facts: true
  tags: [deploy, deploy-haproxy]
  tasks:
    - name: Install HAProxy
      ansible.builtin.apt:
        name: haproxy
        state: present
        update_cache: true
        cache_valid_time: 3600

    - name: Deploy config
      ansible.builtin.template:
        src: templates/haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        owner: root
        group: root
        mode: "0644"
        backup: true
        validate: "haproxy -c -f %s"
      register: haproxy_config

    - name: Restart HAProxy
      ansible.builtin.systemd:
        name: haproxy
        state: restarted
        enabled: true
        daemon_reload: true
      when: haproxy_config.changed

    - name: Ensure HAProxy running
      ansible.builtin.systemd:
        name: haproxy
        state: started
        enabled: true

    - name: Verify listening
      ansible.builtin.shell: ss -tlnp | grep ":{{ mysql_port }}"
      register: haproxy_check
      changed_when: false
      retries: 3
      delay: 2
      until: haproxy_check.rc == 0

# =============================================================================
# DEPLOY: Verify
# =============================================================================
- name: Verify Deployment
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [deploy, deploy-mariadb]
  tasks:
    - name: Get cluster size
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null || echo "0"
      register: final_size
      changed_when: false
      no_log: true

    - name: Display result
      ansible.builtin.debug:
        msg: |
          ============================================
          Deployment Complete!
          ============================================
          Cluster Size: {{ final_size.stdout }}/{{ mariadb_nodes | length }}
          {% if haproxy_nodes | length > 0 %}
          Connect: mysql -h {{ haproxy_nodes[0].ip }} -u {{ admin_user }} -p
          Stats: http://{{ haproxy_nodes[0].ip }}:{{ haproxy_stats_port }}/stats
          {% else %}
          Connect: mysql -h {{ mariadb_nodes[0].ip }} -u {{ admin_user }} -p
          {% endif %}
          ============================================

# =============================================================================
# STATUS: Check Cluster
# =============================================================================
- name: Check MariaDB Status
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service
      ansible.builtin.command: systemctl is-active mariadb
      register: svc
      changed_when: false
      failed_when: false

    - name: Get wsrep info
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "
        SELECT CONCAT_WS(',',
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_status'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_local_state_comment'),
          (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_ready')
        );" 2>/dev/null || echo "N/A,N/A,N/A,N/A"
      register: wsrep
      changed_when: false
      no_log: true

    - name: Set status
      ansible.builtin.set_fact:
        node_status:
          name: "{{ node_name }}"
          ip: "{{ node_ip }}"
          service: "{{ svc.stdout }}"
          size: "{{ wsrep.stdout.split(',')[0] }}"
          status: "{{ wsrep.stdout.split(',')[1] }}"
          state: "{{ wsrep.stdout.split(',')[2] }}"
          ready: "{{ wsrep.stdout.split(',')[3] }}"

- name: Check HAProxy Status
  hosts: loadbalancers
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service
      ansible.builtin.command: systemctl is-active haproxy
      register: svc
      changed_when: false
      failed_when: false

    - name: Check port
      ansible.builtin.shell: ss -tlnp | grep -q ":{{ mysql_port }}" && echo "listening" || echo "not listening"
      register: port
      changed_when: false

    - name: Set status
      ansible.builtin.set_fact:
        haproxy_status:
          name: "{{ node_name }}"
          ip: "{{ node_ip }}"
          service: "{{ svc.stdout }}"
          port: "{{ port.stdout }}"

- name: Check Garbd Status
  hosts: garbd
  become: true
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Check service
      ansible.builtin.command: systemctl is-active garb
      register: svc
      changed_when: false
      failed_when: false

    - name: Set status
      ansible.builtin.set_fact:
        garbd_status:
          name: "{{ node_name }}"
          service: "{{ svc.stdout }}"

- name: Display Status
  hosts: localhost
  gather_facts: false
  tags: [status, status-detailed]
  tasks:
    - name: Show status
      ansible.builtin.debug:
        msg: |
          ============================================
          MariaDB Galera Cluster Status
          ============================================
          
          MARIADB:
          {% for h in groups['mariadb'] %}
          {{ hostvars[h]['node_status']['name'] }} ({{ hostvars[h]['node_status']['ip'] }})
            Service: {{ hostvars[h]['node_status']['service'] }}
            Cluster: {{ hostvars[h]['node_status']['size'] }} nodes | {{ hostvars[h]['node_status']['status'] }}
            State: {{ hostvars[h]['node_status']['state'] }} | Ready: {{ hostvars[h]['node_status']['ready'] }}
          {% endfor %}
          {% if groups['loadbalancers'] | default([]) | length > 0 %}
          
          HAPROXY:
          {% for h in groups['loadbalancers'] %}
          {{ hostvars[h]['haproxy_status']['name'] }} ({{ hostvars[h]['haproxy_status']['ip'] }})
            Service: {{ hostvars[h]['haproxy_status']['service'] }} | Port: {{ hostvars[h]['haproxy_status']['port'] }}
            Stats: http://{{ hostvars[h]['haproxy_status']['ip'] }}:{{ haproxy_stats_port }}/stats
          {% endfor %}
          {% endif %}
          {% if groups['garbd'] | default([]) | length > 0 %}
          
          GARBD:
          {% for h in groups['garbd'] %}
          {{ hostvars[h]['garbd_status']['name'] }}: {{ hostvars[h]['garbd_status']['service'] }}
          {% endfor %}
          {% endif %}
          ============================================

- name: Detailed Status
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [status-detailed]
  tasks:
    - name: Get full wsrep
      ansible.builtin.shell: |
        mariadb -u {{ admin_user }} -p'{{ admin_password }}' -e "SHOW STATUS LIKE 'wsrep_%';" 2>/dev/null
      register: full
      changed_when: false
      no_log: true

    - name: Display
      ansible.builtin.debug:
        msg: |
          === {{ node_name }} ===
          {{ full.stdout }}
      when: full.rc == 0

# =============================================================================
# RECOVER: Cluster Recovery
# =============================================================================
- name: Validate Recovery
  hosts: localhost
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Check confirmation
      ansible.builtin.fail:
        msg: |
          ============================================
          RECOVERY REQUIRES CONFIRMATION
          ============================================
          Run with: ansible-playbook mariadb.yml --tags recover -e confirm=yes
          ============================================
      when: not (confirm | default(false) | bool)

- name: Stop All MariaDB
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Stop MariaDB
      ansible.builtin.systemd:
        name: mariadb
        state: stopped
      ignore_errors: true
      when: confirm | default(false) | bool

- name: Stop Garbd
  hosts: garbd
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Stop garbd
      ansible.builtin.systemd:
        name: garb
        state: stopped
      ignore_errors: true
      when: confirm | default(false) | bool

- name: Find Best Node
  hosts: mariadb
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Read grastate
      ansible.builtin.slurp:
        src: "{{ mysql_data_dir }}/grastate.dat"
      register: grastate
      ignore_errors: true
      when: confirm | default(false) | bool

    - name: Parse seqno
      ansible.builtin.set_fact:
        node_seqno: "{{ (grastate.content | b64decode | regex_search('seqno:\\s*(-?\\d+)', '\\1'))[0] | default('-1') }}"
      when:
        - confirm | default(false) | bool
        - grastate is succeeded

    - name: Default seqno
      ansible.builtin.set_fact:
        node_seqno: "-1"
      when:
        - confirm | default(false) | bool
        - grastate is failed

    - name: Show seqno
      ansible.builtin.debug:
        msg: "{{ node_name }}: seqno={{ node_seqno }}"
      when: confirm | default(false) | bool

- name: Select Bootstrap Node
  hosts: localhost
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Find best node
      when: confirm | default(false) | bool
      block:
        - name: Collect seqnos
          ansible.builtin.set_fact:
            seqnos: "{{ seqnos | default({}) | combine({item: hostvars[item]['node_seqno'] | int}) }}"
          loop: "{{ groups['mariadb'] }}"

        - name: Select highest
          ansible.builtin.set_fact:
            bootstrap_node: "{{ (seqnos | dict2items | sort(attribute='value', reverse=true) | first).key }}"

        - name: Display
          ansible.builtin.debug:
            msg: "Bootstrap node: {{ bootstrap_node }}"

- name: Bootstrap Recovery
  hosts: mariadb
  become: true
  gather_facts: false
  serial: 1
  tags: [recover]
  tasks:
    - name: Recovery
      when: confirm | default(false) | bool
      block:
        - name: Check if bootstrap
          ansible.builtin.set_fact:
            is_bootstrap: "{{ inventory_hostname == hostvars['localhost']['bootstrap_node'] }}"

        - name: Set safe_to_bootstrap
          ansible.builtin.lineinfile:
            path: "{{ mysql_data_dir }}/grastate.dat"
            regexp: "^safe_to_bootstrap:"
            line: "safe_to_bootstrap: 1"
          when: is_bootstrap

        - name: Bootstrap
          ansible.builtin.command: galera_new_cluster
          when: is_bootstrap

        - name: Wait for bootstrap
          ansible.builtin.wait_for:
            port: "{{ mysql_port }}"
            host: "{{ node_ip }}"
            delay: 3
            timeout: 120
          when: is_bootstrap

        - name: Start other nodes
          ansible.builtin.systemd:
            name: mariadb
            state: started
          when: not is_bootstrap

        - name: Wait for sync
          ansible.builtin.shell: |
            for i in $(seq 1 60); do
              if ss -tlnp | grep -q ":3306" && systemctl is-active mariadb >/dev/null 2>&1; then
                sleep 3
                exit 0
              fi
              sleep 2
            done
            exit 1
          changed_when: false
          when: not is_bootstrap

- name: Restart Garbd
  hosts: garbd
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Start garbd
      ansible.builtin.systemd:
        name: garb
        state: started
      when: confirm | default(false) | bool

- name: Verify Recovery
  hosts: mariadb[0]
  become: true
  gather_facts: false
  tags: [recover]
  tasks:
    - name: Get size
      ansible.builtin.shell: |
        mariadb --socket=/run/mysqld/mysqld.sock -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || mariadb -u {{ admin_user }} -p'{{ admin_password }}' -N -e "SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='wsrep_cluster_size';" 2>/dev/null \
        || echo "0"
      register: size
      changed_when: false
      no_log: true
      when: confirm | default(false) | bool

    - name: Display
      ansible.builtin.debug:
        msg: |
          ============================================
          Recovery Complete!
          Cluster Size: {{ size.stdout }}/{{ mariadb_nodes | length }}
          ============================================
      when: confirm | default(false) | bool
