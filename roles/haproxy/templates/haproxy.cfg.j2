# HAProxy Configuration for MariaDB Galera Cluster
# Generated by Ansible - Load Balancer: {{ node_name }} ({{ node_ip }})

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  30m
    timeout server  30m

listen mariadb_cluster
    bind {{ node_ip }}:{{ mysql_port }}
    mode tcp
    option tcplog
    option tcpka
    balance roundrobin
    option tcp-check
    tcp-check connect
{% for node in mariadb_nodes %}
    server {{ node.name }} {{ node.ip }}:{{ mysql_port }} check inter 5s rise 2 fall 3
{% endfor %}

{% if haproxy_stats_enabled %}
listen stats
    bind {{ node_ip }}:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
{% endif %}
